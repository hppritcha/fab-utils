
Instructions for building and running DOE mini app CoMD.
For additional information see internal Mini Apps wiki.

1. Download 
   > git clone https://github.com/exmatex/CoMD

2. There is a top-level README.md with a somewhat useful link in it.

3. Load necessary PrgEnv module, set PATH and LD_LIBRARY_PATH and set recommended environment variables,
   e.g. for OMPI, etc.

4. Create and modify Makefile. a) is necessary, b) depends on which compiler is used. 

   a) 
   > cd src-openmp
   > cp Makefile.vanilla Makefile

   b) When using Intel and building for KNL, add KNL option and optionally -qopt-report if an
      optimization report should be generated.

   #CFLAGS = -std=c99 -fopenmp
   CFLAGS = -std=c99 -fopenmp -axMIC-AVX512 -v

5. > make clean
   > make
   This creates the executable CoMD-openmp-mpi under ../bin.

6. Now build other apps and run the app run script run_minapps found in the same directory
   as these notes. For run instructions see comments in the script itself.

   Alternatively, a few suggested launch options follow. For each example, the number
   of nodes used can be varied depending on whether XEON or KNL nodes are used. When
   launching CoMD, the number of MPI ranks must match xproc * yproc * zproc, where
   -i<xproc> -j<yproc> -k<zproc>. If a run fails with "Simulation to small" use the
   -x, -y, -z input parameters to increase simulation size.

   a) To run a small job
   > export OMP_NUM_THREADS=2
   > srun -n 8 -N 2 -c 2 --exclusive <path/exec> -i2 -j2 -k2
   or
   > export OMP_NUM_THREADS=2
   > aprun -n 8 -N 4 -d 2 <path/exec> -i2 -j2 -k2

   where <path/exec> points to the binary.

   b) To run a somewhat larger job
   > export OMP_NUM_THREADS=4
   > srun -n 64 -N 8 -c 4 --exclusive <path/exec> -i4 -j4 -k4
   or
   > export OMP_NUM_THREADS=4
   > aprun -n 64 -N 8 -d 4 <path/exec> -i4 -j4 -k4

   c) Suitable for tiger
   > export OMP_NUM_THREADS=4
   > srun -n 216 -N 18 -c 4 --exclusive <path/exec> -i6 -j6 -k6
   or 
   > export OMP_NUM_THREADS=4
   > aprun -n 216 -N 12 -d 4 -cc depth <path/exec> -i6 -j6 -k6

   d) Suitable for KNL systems
   > export OMP_NUM_THREADS=4
   > srun -n 512 --ntasks-per-node=32 -c 4 --exclusive <path/exec> -i8 -j8 -k8 -x40 -y40 -z40
   or
   > export OMP_NUM_THREADS=4
   > aprun -n 512 -N 32 -d 4 -j 2 <path/exec> -i8 -j8 -k8 -x40 -y40 -z40

   e) Maximum size run on current KNL systems, SLURM only
   > export OMP_NUM_THREADS=4
   > srun -n 8000 --ntasks-per-node=64 -c 4 --exclusive <path/exec> -i20 -j20 -k20 -x80 -y80 -z80

7. For each run, look for a date and time stamp and "CoMD Ending" as the last line of output.
   A unique output file CoMD... with date and time stamp is created in the same directory
   but generally can be ignored.

8. Performance data is summarized at the end of each run. Look for "Average atom rate"
   and possibly also atom updated rates.

   None of the srun or aprun command line options should be assumed to be optimal for
   performance investigations.

